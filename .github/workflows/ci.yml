# ============================================================
# üöÄ NOVA √âv√©nements - CI/CD Pipeline
# ============================================================
# Pipeline simple: Lint PHP + Analyse SonarCloud
# ============================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ===================================================================
  # JOB 1: V√âRIFICATION PHP
  # ===================================================================
  php-check:
    name: üêò PHP Lint
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: ‚úÖ V√©rification syntaxe PHP
        run: |
          echo "üîç V√©rification de la syntaxe PHP..."
          errors=0
          
          for file in $(find . -name "*.php" -not -path "./vendor/*"); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Erreur: $file"
              php -l "$file"
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "‚ùå $errors erreur(s) de syntaxe"
            exit 1
          fi
          
          echo "‚úÖ Syntaxe PHP OK"

  # ===================================================================
  # JOB 2: ANALYSE SONARCLOUD
  # ===================================================================
  sonarcloud:
    name: üî¨ SonarCloud
    runs-on: ubuntu-latest
    needs: php-check

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üî¨ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
