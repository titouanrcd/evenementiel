# ============================================================
# üöÄ NOVA √âv√©nements - CI/CD Pipeline
# ============================================================
# Pipeline: Lint PHP + Analyse SonarQube + S√©curit√© (ZAP)
# ============================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # ===================================================================
  # JOB 1: V√âRIFICATION PHP
  # ===================================================================
  php-check:
    name: üêò PHP Lint
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: ‚úÖ V√©rification syntaxe PHP
        run: |
          echo "üîç V√©rification de la syntaxe PHP..."
          errors=0
          
          # Recherche de tous les fichiers .php (hors vendor)
          for file in $(find . -name "*.php" -not -path "./vendor/*"); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "‚ùå Erreur: $file"
              php -l "$file"
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "‚ùå $errors erreur(s) de syntaxe d√©tect√©e(s)."
            exit 1
          fi
          
          echo "‚úÖ Syntaxe PHP OK"

  # ===================================================================
  # JOB 2: ANALYSE SONARQUBE (Self-Hosted)
  # ===================================================================
  sonarqube:
    name: üî¨ SonarQube Analysis
    runs-on: ubuntu-latest
    needs: php-check

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ‚ö†Ô∏è Obligatoire pour une analyse pr√©cise

      - name: üî¨ SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          args: >
            -Dsonar.projectKey=ShadowRich_evenementiel
            -Dsonar.verbose=false

  # ===================================================================
  # JOB 3: S√âCURIT√â (OWASP ZAP)
  # ===================================================================
  security-scan:
    name: üõ°Ô∏è OWASP ZAP Scan
    runs-on: ubuntu-latest
    needs: php-check

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üêò Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"

      - name: üöÄ D√©marrer Serveur PHP (Background)
        run: |
          # D√©marrage du serveur PHP int√©gr√© sur le port 8080
          php -S 0.0.0.0:8080 -t public > /dev/null 2>&1 &
          echo "‚è≥ Attente du d√©marrage du serveur..."
          sleep 5

      - name: üï∑Ô∏è Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: 'http://localhost:8080'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          fail_action: false # Met √† true si tu veux bloquer la CI en cas de faille
          allow_issue_writing: false