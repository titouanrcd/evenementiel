# ============================================================
# ðŸ”’ NOVA Ã‰vÃ©nements - Pipeline de SÃ©curitÃ© CI/CD
# ============================================================
# Ce workflow s'exÃ©cute Ã  chaque push/PR pour vÃ©rifier la sÃ©curitÃ©
# ============================================================

name: ðŸ”’ Security & Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  # Permet l'exÃ©cution manuelle depuis GitHub
  workflow_dispatch:

jobs:
  # ===================================================================
  # JOB 1: VÃ‰RIFICATION DE LA SYNTAXE PHP
  # ===================================================================
  php-lint:
    name: ðŸ˜ PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ˜ Configuration de PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: âœ… VÃ©rification de la syntaxe PHP
        run: |
          echo "ðŸ” VÃ©rification de la syntaxe de tous les fichiers PHP..."
          errors=0
          
          for file in $(find . -name "*.php" -not -path "./vendor/*"); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "âŒ Erreur de syntaxe: $file"
              php -l "$file"
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "âŒ $errors fichier(s) avec des erreurs de syntaxe"
            exit 1
          else
            echo "âœ… Tous les fichiers PHP sont valides!"
          fi

  # ===================================================================
  # JOB 2: ANALYSE DE SÃ‰CURITÃ‰ STATIQUE
  # ===================================================================
  security-scan:
    name: ðŸ›¡ï¸ Security Analysis
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ” Recherche de patterns dangereux
        run: |
          echo "ðŸ” Analyse des vulnÃ©rabilitÃ©s potentielles..."
          echo ""
          vulnerabilities=0
          
          # === Test 1: RequÃªtes SQL non prÃ©parÃ©es ===
          echo "ðŸ“‹ Test 1: RequÃªtes SQL non prÃ©parÃ©es..."
          if grep -rn "query\s*(\s*[\"'].*\\\$" views/*.php 2>/dev/null; then
            echo "âš ï¸ ATTENTION: RequÃªtes SQL potentiellement non prÃ©parÃ©es dÃ©tectÃ©es"
            vulnerabilities=$((vulnerabilities + 1))
          else
            echo "âœ… Aucune requÃªte SQL non prÃ©parÃ©e dÃ©tectÃ©e"
          fi
          echo ""
          
          # === Test 2: Utilisation de eval() ===
          echo "ðŸ“‹ Test 2: Utilisation de eval()..."
          if grep -rn "\beval\s*(" views/*.php 2>/dev/null; then
            echo "âŒ CRITIQUE: Utilisation de eval() dÃ©tectÃ©e!"
            vulnerabilities=$((vulnerabilities + 1))
          else
            echo "âœ… Pas d'utilisation de eval()"
          fi
          echo ""
          
          # === Test 3: Utilisation de shell_exec/system/exec ===
          echo "ðŸ“‹ Test 3: Fonctions shell dangereuses..."
          if grep -rn "\b\(shell_exec\|system\|exec\|passthru\|popen\)\s*(" views/*.php 2>/dev/null; then
            echo "âŒ CRITIQUE: Fonctions shell dangereuses dÃ©tectÃ©es!"
            vulnerabilities=$((vulnerabilities + 1))
          else
            echo "âœ… Pas de fonctions shell dangereuses"
          fi
          echo ""
          
          # === Test 4: Inclusion de fichiers dynamique ===
          echo "ðŸ“‹ Test 4: Inclusions dynamiques..."
          if grep -rn "\b\(include\|require\|include_once\|require_once\)\s*(\s*\\\$" views/*.php 2>/dev/null; then
            echo "âš ï¸ ATTENTION: Inclusions dynamiques dÃ©tectÃ©es"
            vulnerabilities=$((vulnerabilities + 1))
          else
            echo "âœ… Pas d'inclusions dynamiques dangereuses"
          fi
          echo ""
          
          # === Test 5: DÃ©sÃ©rialisation non sÃ©curisÃ©e ===
          echo "ðŸ“‹ Test 5: DÃ©sÃ©rialisation..."
          if grep -rn "\bunserialize\s*(\s*\\\$" views/*.php 2>/dev/null; then
            echo "âŒ CRITIQUE: DÃ©sÃ©rialisation de donnÃ©es utilisateur!"
            vulnerabilities=$((vulnerabilities + 1))
          else
            echo "âœ… Pas de dÃ©sÃ©rialisation dangereuse"
          fi
          echo ""
          
          # === RÃ©sumÃ© ===
          echo "========================================"
          if [ $vulnerabilities -gt 0 ]; then
            echo "âš ï¸ $vulnerabilities vulnÃ©rabilitÃ©(s) potentielle(s) dÃ©tectÃ©e(s)"
            echo "Veuillez vÃ©rifier et corriger ces problÃ¨mes"
          else
            echo "âœ… Aucune vulnÃ©rabilitÃ© critique dÃ©tectÃ©e!"
          fi

      - name: ðŸ” VÃ©rification des secrets exposÃ©s
        run: |
          echo "ðŸ” Recherche de secrets potentiellement exposÃ©s..."
          secrets_found=0
          
          # Patterns de secrets courants
          patterns=(
            "api[_-]?key\s*=\s*['\"][^'\"]{10,}['\"]"
            "secret[_-]?key\s*=\s*['\"][^'\"]{10,}['\"]"
            "aws[_-]?access[_-]?key"
            "private[_-]?key"
          )
          
          for pattern in "${patterns[@]}"; do
            if grep -riE "$pattern" --include="*.php" --include="*.js" --include="*.env" . 2>/dev/null | grep -v "node_modules"; then
              echo "âš ï¸ Pattern suspect trouvÃ©: $pattern"
              secrets_found=$((secrets_found + 1))
            fi
          done
          
          if [ $secrets_found -eq 0 ]; then
            echo "âœ… Aucun secret exposÃ© dÃ©tectÃ©"
          else
            echo "âš ï¸ $secrets_found pattern(s) suspect(s) trouvÃ©(s)"
          fi

  # ===================================================================
  # JOB 3: VÃ‰RIFICATION DES PROTECTIONS DE SÃ‰CURITÃ‰
  # ===================================================================
  security-checks:
    name: ðŸ”’ Security Protections Check
    runs-on: ubuntu-latest
    needs: php-lint
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ VÃ©rification de la protection CSRF
        run: |
          echo "ðŸ” VÃ©rification de la protection CSRF..."
          
          if [ -f "views/security.php" ]; then
            if grep -q "csrf_token" views/security.php; then
              echo "âœ… Fichier security.php avec CSRF dÃ©tectÃ©"
            else
              echo "âŒ Protection CSRF non trouvÃ©e dans security.php"
              exit 1
            fi
          else
            echo "âŒ Fichier views/security.php manquant!"
            exit 1
          fi
          
          # VÃ©rifier que les formulaires utilisent le CSRF
          csrf_forms=$(grep -r "csrfField()" views/*.php 2>/dev/null | wc -l)
          echo "ðŸ“Š $csrf_forms formulaire(s) protÃ©gÃ©(s) par CSRF"
          
          if [ $csrf_forms -lt 5 ]; then
            echo "âš ï¸ Attention: Peu de formulaires semblent protÃ©gÃ©s par CSRF"
          else
            echo "âœ… Bonne couverture CSRF"
          fi

      - name: ðŸ”’ VÃ©rification des headers de sÃ©curitÃ©
        run: |
          echo "ðŸ” VÃ©rification des headers de sÃ©curitÃ©..."
          
          headers_ok=0
          headers_missing=0
          
          # VÃ©rifier .htaccess
          if [ -f ".htaccess" ]; then
            echo "ðŸ“„ Analyse de .htaccess..."
            
            if grep -q "X-Frame-Options" .htaccess; then
              echo "  âœ… X-Frame-Options (anti-clickjacking)"
              headers_ok=$((headers_ok + 1))
            else
              echo "  âŒ X-Frame-Options manquant"
              headers_missing=$((headers_missing + 1))
            fi
            
            if grep -q "X-XSS-Protection" .htaccess; then
              echo "  âœ… X-XSS-Protection"
              headers_ok=$((headers_ok + 1))
            else
              echo "  âŒ X-XSS-Protection manquant"
              headers_missing=$((headers_missing + 1))
            fi
            
            if grep -q "X-Content-Type-Options" .htaccess; then
              echo "  âœ… X-Content-Type-Options"
              headers_ok=$((headers_ok + 1))
            else
              echo "  âŒ X-Content-Type-Options manquant"
              headers_missing=$((headers_missing + 1))
            fi
          else
            echo "âŒ Fichier .htaccess manquant!"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“Š RÃ©sultat: $headers_ok headers OK, $headers_missing manquants"
          
          if [ $headers_missing -gt 0 ]; then
            exit 1
          fi

      - name: ðŸ“ VÃ©rification protection uploads
        run: |
          echo "ðŸ” VÃ©rification de la protection du dossier uploads..."
          
          if [ -f "uploads/.htaccess" ]; then
            echo "âœ… Fichier uploads/.htaccess prÃ©sent"
            
            if grep -q "php.*off\|\.php.*denied" uploads/.htaccess; then
              echo "âœ… ExÃ©cution PHP dÃ©sactivÃ©e dans uploads"
            else
              echo "âš ï¸ VÃ©rifiez que l'exÃ©cution PHP est bien bloquÃ©e"
            fi
          else
            echo "âŒ Fichier uploads/.htaccess manquant!"
            echo "   Risque: Les fichiers PHP uploadÃ©s pourraient Ãªtre exÃ©cutÃ©s"
            exit 1
          fi

      - name: ðŸ” VÃ©rification hashage mots de passe
        run: |
          echo "ðŸ” VÃ©rification du hashage des mots de passe..."
          
          if grep -r "password_hash" views/*.php > /dev/null 2>&1; then
            echo "âœ… password_hash() utilisÃ©"
          else
            echo "âŒ password_hash() non trouvÃ©!"
            exit 1
          fi
          
          if grep -r "password_verify" views/*.php > /dev/null 2>&1; then
            echo "âœ… password_verify() utilisÃ©"
          else
            echo "âŒ password_verify() non trouvÃ©!"
            exit 1
          fi
          
          # VÃ©rifier qu'on n'utilise pas md5/sha1 pour les mots de passe
          if grep -rE "md5\s*\(\s*\\\$.*password|sha1\s*\(\s*\\\$.*password" views/*.php 2>/dev/null; then
            echo "âŒ CRITIQUE: MD5/SHA1 utilisÃ© pour les mots de passe!"
            exit 1
          else
            echo "âœ… Pas de hashage faible dÃ©tectÃ©"
          fi

      - name: ðŸ›¡ï¸ VÃ©rification requÃªtes prÃ©parÃ©es PDO
        run: |
          echo "ðŸ” VÃ©rification de l'utilisation des requÃªtes prÃ©parÃ©es..."
          
          # Compter les prepare()
          prepare_count=$(grep -r "->prepare(" views/*.php 2>/dev/null | wc -l)
          echo "ðŸ“Š $prepare_count requÃªtes prÃ©parÃ©es trouvÃ©es"
          
          # VÃ©rifier la configuration PDO
          if grep -q "ATTR_EMULATE_PREPARES.*false" views/db.php 2>/dev/null; then
            echo "âœ… Ã‰mulation des requÃªtes prÃ©parÃ©es dÃ©sactivÃ©e"
          else
            echo "âš ï¸ Recommandation: DÃ©sactivez ATTR_EMULATE_PREPARES"
          fi
          
          if [ $prepare_count -gt 0 ]; then
            echo "âœ… RequÃªtes prÃ©parÃ©es utilisÃ©es"
          else
            echo "âš ï¸ Peu de requÃªtes prÃ©parÃ©es dÃ©tectÃ©es"
          fi

  # ===================================================================
  # JOB 4: RAPPORT FINAL
  # ===================================================================
  security-report:
    name: ðŸ“‹ Security Report
    runs-on: ubuntu-latest
    needs: [php-lint, security-scan, security-checks]
    if: always()
    
    steps:
      - name: ðŸ“Š GÃ©nÃ©ration du rapport
        run: |
          echo "# ðŸ”’ Rapport de SÃ©curitÃ© CI/CD - NOVA Ã‰vÃ©nements" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%d/%m/%Y %H:%M')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branche:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## RÃ©sultats des vÃ©rifications" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| VÃ©rification | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ˜ Syntaxe PHP | ${{ needs.php-lint.result == 'success' && 'âœ… OK' || 'âŒ Ã‰chec' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›¡ï¸ Analyse de sÃ©curitÃ© | ${{ needs.security-scan.result == 'success' && 'âœ… OK' || 'âŒ Ã‰chec' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Protections actives | ${{ needs.security-checks.result == 'success' && 'âœ… OK' || 'âŒ Ã‰chec' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.php-lint.result }}" == "success" ] && [ "${{ needs.security-scan.result }}" == "success" ] && [ "${{ needs.security-checks.result }}" == "success" ]; then
            echo "## âœ… Toutes les vÃ©rifications sont passÃ©es!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Le code est prÃªt pour le dÃ©ploiement." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Certaines vÃ©rifications ont Ã©chouÃ©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Veuillez corriger les problÃ¨mes avant de fusionner." >> $GITHUB_STEP_SUMMARY
          fi
