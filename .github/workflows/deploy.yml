# ============================================================
# üöÄ NOVA √âv√©nements - Pipeline de D√©ploiement
# ============================================================
# Ce workflow d√©ploie automatiquement sur le serveur de production
# apr√®s validation des tests de s√©curit√©
# ============================================================

name: üöÄ Deploy to Production

on:
  # D√©ploiement automatique apr√®s push sur main
  push:
    branches: [ main ]
  
  # Permet le d√©ploiement manuel depuis l'interface GitHub
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement de d√©ploiement'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

# S'assurer qu'un seul d√©ploiement √† la fois
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===================================================================
  # JOB 1: V√âRIFICATIONS PR√â-D√âPLOIEMENT
  # ===================================================================
  pre-deploy:
    name: ‚úÖ Pre-Deploy Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîç V√©rification des fichiers requis
        run: |
          echo "üîç V√©rification des fichiers de s√©curit√©..."
          
          required_files=(
            "views/security.php"
            "views/db.php"
            ".htaccess"
            "uploads/.htaccess"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "‚úÖ $file"
            else
              echo "‚ùå $file MANQUANT!"
              missing=$((missing + 1))
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo ""
            echo "‚ùå $missing fichier(s) requis manquant(s)"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Tous les fichiers requis sont pr√©sents"

      - name: üîê V√©rification mode production
        run: |
          echo "üîç V√©rification de la configuration pour la production..."
          
          # V√©rifier que le mode debug n'est pas activ√©
          if grep -q "ENVIRONMENT.*development" views/security.php; then
            echo "‚ö†Ô∏è ATTENTION: Mode d√©veloppement d√©tect√©!"
            echo "   Modifiez ENVIRONMENT en 'production' dans security.php"
            echo "   (Ce n'est pas bloquant mais recommand√©)"
          else
            echo "‚úÖ Configuration OK pour la production"
          fi
          
          # V√©rifier que les erreurs sont masqu√©es
          if grep -q "display_errors.*Off\|display_errors.*0" .htaccess 2>/dev/null; then
            echo "‚úÖ Affichage des erreurs d√©sactiv√©"
          else
            echo "‚ö†Ô∏è Recommandation: D√©sactivez display_errors en production"
          fi

      - name: üìã Liste des fichiers √† d√©ployer
        run: |
          echo "üìã Fichiers qui seront d√©ploy√©s:"
          echo ""
          
          # Exclure les fichiers de d√©veloppement
          find . -type f \
            -not -path "./.git/*" \
            -not -path "./.github/*" \
            -not -path "./node_modules/*" \
            -not -path "./vendor/*" \
            -not -name "*.md" \
            -not -name ".gitignore" \
            -not -name "composer.*" \
            -not -name "package*.json" \
            | head -50
          
          echo ""
          echo "... et plus"

  # ===================================================================
  # JOB 2: EX√âCUTION DES TESTS DE S√âCURIT√â
  # ===================================================================
  security-gate:
    name: üõ°Ô∏è Security Gate
    runs-on: ubuntu-latest
    needs: pre-deploy
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîí Tests de s√©curit√© rapides
        run: |
          echo "üîí Ex√©cution des tests de s√©curit√© critiques..."
          
          errors=0
          
          # Test 1: Pas de credentials en dur
          echo "üìã Test 1: V√©rification des credentials..."
          if grep -rE "password\s*=\s*['\"][a-zA-Z0-9]+['\"]" views/db.php | grep -v "password.*=.*''"; then
            echo "‚ö†Ô∏è Mot de passe potentiellement en dur dans db.php"
          fi
          
          # Test 2: Protection CSRF active
          echo "üìã Test 2: Protection CSRF..."
          if ! grep -q "verifyCsrfToken" views/security.php; then
            echo "‚ùå Fonction verifyCsrfToken manquante!"
            errors=$((errors + 1))
          else
            echo "‚úÖ Protection CSRF pr√©sente"
          fi
          
          # Test 3: Hashage s√©curis√©
          echo "üìã Test 3: Hashage des mots de passe..."
          if grep -q "PASSWORD_BCRYPT\|PASSWORD_DEFAULT" views/connexion.php; then
            echo "‚úÖ Hashage bcrypt utilis√©"
          else
            echo "‚ùå Hashage s√©curis√© non d√©tect√©!"
            errors=$((errors + 1))
          fi
          
          # Test 4: Headers de s√©curit√©
          echo "üìã Test 4: Headers de s√©curit√©..."
          if grep -q "X-Frame-Options" .htaccess; then
            echo "‚úÖ Headers de s√©curit√© configur√©s"
          else
            echo "‚ùå Headers de s√©curit√© manquants!"
            errors=$((errors + 1))
          fi
          
          echo ""
          if [ $errors -gt 0 ]; then
            echo "‚ùå $errors erreur(s) de s√©curit√© critique(s)"
            exit 1
          else
            echo "‚úÖ Tous les tests de s√©curit√© sont pass√©s!"
          fi

  # ===================================================================
  # JOB 3: D√âPLOIEMENT FTP (H√©bergement classique)
  # ===================================================================
  deploy-ftp:
    name: üöÄ Deploy via FTP
    runs-on: ubuntu-latest
    needs: [pre-deploy, security-gate]
    environment: production
    # D√©commentez cette ligne pour activer le d√©ploiement FTP
    if: false  # Mettre √† true pour activer
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üì§ D√©ploiement FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: /www/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.github/**
            **/test/**
            **/*.md
            **/composer.*
            **/package*.json

  # ===================================================================
  # JOB 4: D√âPLOIEMENT SSH (VPS/Serveur d√©di√©)
  # ===================================================================
  deploy-ssh:
    name: üöÄ Deploy via SSH
    runs-on: ubuntu-latest
    needs: [pre-deploy, security-gate]
    environment: production
    # D√©commentez cette ligne pour activer le d√©ploiement SSH
    if: false  # Mettre √† true pour activer
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üîë Configuration SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: üì§ D√©ploiement SSH
        run: |
          # Synchronisation des fichiers
          rsync -avz --delete \
            --exclude='.git*' \
            --exclude='node_modules' \
            --exclude='.github' \
            --exclude='test' \
            --exclude='*.md' \
            --exclude='composer.*' \
            ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.SSH_PATH }}
          
          # Commandes post-d√©ploiement
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.SSH_PATH }}
            
            # Permissions s√©curis√©es
            find . -type f -exec chmod 644 {} \;
            find . -type d -exec chmod 755 {} \;
            chmod 755 uploads/
            
            # Vider le cache si n√©cessaire
            # php artisan cache:clear  # Pour Laravel
            
            echo "‚úÖ D√©ploiement termin√©!"
          EOF

  # ===================================================================
  # JOB 5: NOTIFICATION
  # ===================================================================
  notify:
    name: üì¨ Notification
    runs-on: ubuntu-latest
    needs: [pre-deploy, security-gate]
    if: always()
    
    steps:
      - name: üìä R√©sum√© du d√©ploiement
        run: |
          echo "# üöÄ R√©sum√© du D√©ploiement" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%d/%m/%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auteur:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Statut des jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Pre-Deploy | ${{ needs.pre-deploy.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Gate | ${{ needs.security-gate.result == 'success' && '‚úÖ' || '‚ùå' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.security-gate.result }}" == "success" ]; then
            echo "## ‚úÖ Pr√™t pour le d√©ploiement!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Le code a pass√© toutes les v√©rifications de s√©curit√©." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå D√©ploiement bloqu√©" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Des v√©rifications de s√©curit√© ont √©chou√©. Corrigez les probl√®mes avant de red√©ployer." >> $GITHUB_STEP_SUMMARY
          fi
