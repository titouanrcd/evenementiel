# ============================================================
# ğŸ“Š NOVA Ã‰vÃ©nements - Tests AutomatisÃ©s
# ============================================================
# Ce workflow exÃ©cute les tests unitaires et d'intÃ©gration
# ============================================================

name: ğŸ“Š Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ===================================================================
  # JOB 1: TESTS PHP
  # ===================================================================
  php-tests:
    name: ğŸ§ª PHP Tests
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: evenements_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mbstring, json
          coverage: xdebug

      - name: ğŸ—„ï¸ Initialisation base de donnÃ©es
        run: |
          mysql -h 127.0.0.1 -u root -proot evenements_test < gestion_events_etudiants.sql || true
          mysql -h 127.0.0.1 -u root -proot evenements_test < security_update.sql || true

      - name: ğŸ§ª Tests de syntaxe PHP
        run: |
          echo "ğŸ” VÃ©rification de la syntaxe PHP..."
          
          errors=0
          for file in $(find views -name "*.php"); do
            if ! php -l "$file" > /dev/null 2>&1; then
              echo "âŒ Erreur de syntaxe: $file"
              php -l "$file"
              errors=$((errors + 1))
            fi
          done
          
          if [ $errors -gt 0 ]; then
            echo "âŒ $errors erreur(s) de syntaxe dÃ©tectÃ©e(s)"
            exit 1
          fi
          
          echo "âœ… Tous les fichiers PHP sont valides"

      - name: ğŸ“‹ Tests fonctionnels
        run: |
          echo "ğŸ§ª ExÃ©cution des tests fonctionnels..."
          
          # Test 1: VÃ©rification des includes
          echo ""
          echo "ğŸ“‹ Test 1: VÃ©rification des fichiers requis..."
          
          required_includes=(
            "views/security.php"
            "views/db.php"
          )
          
          for file in "${required_includes[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file existe"
            else
              echo "âŒ $file manquant!"
              exit 1
            fi
          done
          
          # Test 2: VÃ©rification des fonctions de sÃ©curitÃ©
          echo ""
          echo "ğŸ“‹ Test 2: Fonctions de sÃ©curitÃ©..."
          
          functions=(
            "generateCsrfToken"
            "verifyCsrfToken"
            "secureSessionStart"
            "sanitizeString"
            "validateEmail"
            "secureUpload"
          )
          
          for func in "${functions[@]}"; do
            if grep -q "function $func" views/security.php; then
              echo "âœ… $func() prÃ©sente"
            else
              echo "âŒ $func() manquante!"
              exit 1
            fi
          done
          
          echo ""
          echo "âœ… Tous les tests fonctionnels passÃ©s!"

      - name: ğŸ“Š Rapport de tests
        run: |
          echo "# ğŸ“Š Rapport de Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%d/%m/%Y %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## RÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Statut |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Syntaxe PHP | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Fichiers requis | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Fonctions de sÃ©curitÃ© | âœ… |" >> $GITHUB_STEP_SUMMARY

  # ===================================================================
  # JOB 2: TESTS FRONTEND
  # ===================================================================
  frontend-tests:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸ¨ Validation CSS
        run: |
          echo "ğŸ” VÃ©rification des fichiers CSS..."
          
          # Compter les fichiers CSS
          css_count=$(find css -name "*.css" | wc -l)
          echo "ğŸ“Š $css_count fichiers CSS trouvÃ©s"
          
          # VÃ©rifier la syntaxe basique (accolades Ã©quilibrÃ©es)
          for file in $(find css -name "*.css"); do
            open=$(grep -o '{' "$file" | wc -l)
            close=$(grep -o '}' "$file" | wc -l)
            
            if [ "$open" -ne "$close" ]; then
              echo "âš ï¸ Accolades non Ã©quilibrÃ©es dans $file"
            else
              echo "âœ… $file"
            fi
          done

      - name: ğŸ” Validation JavaScript
        run: |
          echo "ğŸ” VÃ©rification des fichiers JavaScript..."
          
          for file in $(find js -name "*.js"); do
            # VÃ©rification basique de syntaxe avec Node
            if node --check "$file" 2>/dev/null; then
              echo "âœ… $file"
            else
              echo "âš ï¸ ProblÃ¨me potentiel dans $file"
            fi
          done

      - name: ğŸ“± VÃ©rification responsive
        run: |
          echo "ğŸ“± VÃ©rification du design responsive..."
          
          if grep -q "@media" css/responsive.css; then
            echo "âœ… Media queries dÃ©tectÃ©es dans responsive.css"
            
            # Lister les breakpoints
            echo ""
            echo "ğŸ“Š Breakpoints utilisÃ©s:"
            grep -oE "@media[^{]+" css/responsive.css | head -10
          else
            echo "âš ï¸ Pas de media queries dans responsive.css"
          fi

  # ===================================================================
  # JOB 3: TESTS D'ACCESSIBILITÃ‰
  # ===================================================================
  accessibility-check:
    name: â™¿ Accessibility Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: â™¿ VÃ©rifications d'accessibilitÃ©
        run: |
          echo "â™¿ VÃ©rification des bonnes pratiques d'accessibilitÃ©..."
          
          warnings=0
          
          # Test 1: Attributs alt sur les images
          echo ""
          echo "ğŸ“‹ Test 1: Attributs alt sur les images..."
          
          for file in $(find views -name "*.php"); do
            # Chercher les images sans alt
            if grep -qE '<img[^>]+>' "$file"; then
              if grep -qE '<img[^>]+alt=' "$file"; then
                echo "âœ… $file - images avec attribut alt"
              else
                echo "âš ï¸ $file - images potentiellement sans alt"
                warnings=$((warnings + 1))
              fi
            fi
          done
          
          # Test 2: Labels sur les formulaires
          echo ""
          echo "ğŸ“‹ Test 2: Labels des formulaires..."
          
          for file in $(find views -name "*.php"); do
            if grep -qE '<input[^>]+>' "$file"; then
              if grep -qE '<label' "$file"; then
                echo "âœ… $file - labels prÃ©sents"
              else
                echo "âš ï¸ $file - labels potentiellement manquants"
                warnings=$((warnings + 1))
              fi
            fi
          done
          
          # Test 3: HiÃ©rarchie des titres
          echo ""
          echo "ğŸ“‹ Test 3: HiÃ©rarchie des titres..."
          
          for file in $(find views -name "*.php"); do
            if grep -qE '<h[1-6]' "$file"; then
              echo "âœ… $file - titres prÃ©sents"
            fi
          done
          
          echo ""
          if [ $warnings -gt 0 ]; then
            echo "âš ï¸ $warnings avertissement(s) d'accessibilitÃ©"
            echo "   (Non bloquant mais Ã  amÃ©liorer)"
          else
            echo "âœ… Bonnes pratiques d'accessibilitÃ© respectÃ©es!"
          fi
