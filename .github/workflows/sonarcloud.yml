# ============================================================
# ðŸ”¬ NOVA Ã‰vÃ©nements - Analyse SonarCloud
# ============================================================
# Ce workflow analyse le code avec SonarCloud pour dÃ©tecter:
# - Bugs et vulnÃ©rabilitÃ©s
# - Code smells
# - Couverture de code
# - Duplications
# - Dette technique
# ============================================================

name: ðŸ”¬ SonarCloud Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    name: ðŸ”¬ SonarCloud Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          # RÃ©cupÃ¨re tout l'historique pour une meilleure analyse
          fetch-depth: 0

      - name: ðŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: pdo, pdo_mysql, mbstring, json
          coverage: xdebug

      - name: ðŸ“Š GÃ©nÃ©ration du rapport de couverture
        run: |
          # CrÃ©er un fichier de test basique pour PHPUnit si besoin
          mkdir -p tests
          
          # CrÃ©er un bootstrap pour les tests
          cat > tests/bootstrap.php << 'EOF'
          <?php
          // Bootstrap pour les tests
          error_reporting(E_ALL);
          ini_set('display_errors', '1');
          
          // DÃ©finir les constantes pour les tests
          define('TESTING', true);
          EOF
          
          # CrÃ©er un test basique
          cat > tests/SecurityTest.php << 'EOF'
          <?php
          
          use PHPUnit\Framework\TestCase;
          
          class SecurityTest extends TestCase
          {
              public function testSecurityFileExists(): void
              {
                  $this->assertFileExists(__DIR__ . '/../views/security.php');
              }
              
              public function testDbFileExists(): void
              {
                  $this->assertFileExists(__DIR__ . '/../views/db.php');
              }
              
              public function testHtaccessExists(): void
              {
                  $this->assertFileExists(__DIR__ . '/../.htaccess');
              }
              
              public function testUploadsHtaccessExists(): void
              {
                  $this->assertFileExists(__DIR__ . '/../uploads/.htaccess');
              }
          }
          EOF
          
          # Installer PHPUnit
          composer require --dev phpunit/phpunit ^10 --no-interaction --quiet || true
          
          # ExÃ©cuter les tests avec couverture (si PHPUnit est disponible)
          if [ -f "vendor/bin/phpunit" ]; then
            ./vendor/bin/phpunit tests/ --coverage-clover=coverage.xml || true
          fi

      - name: ðŸ”¬ SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: ðŸ“Š RÃ©sumÃ© de l'analyse
        run: |
          echo "# ðŸ”¬ Analyse SonarCloud" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "L'analyse SonarCloud a Ã©tÃ© exÃ©cutÃ©e avec succÃ¨s!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Voir les rÃ©sultats" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ‘‰ [Dashboard SonarCloud](https://sonarcloud.io/project/overview?id=titouanrcd_evenementiel)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ˆ MÃ©triques analysÃ©es" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MÃ©trique | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ› Bugs | Erreurs potentielles dans le code |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”“ VulnÃ©rabilitÃ©s | Failles de sÃ©curitÃ© |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¦¨ Code Smells | ProblÃ¨mes de maintenabilitÃ© |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‹ Couverture | % de code testÃ© |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“‘ Duplications | Code dupliquÃ© |" >> $GITHUB_STEP_SUMMARY
